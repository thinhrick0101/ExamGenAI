<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exam Generator</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  
  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/1da99de032.js" crossorigin="anonymous"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      font-family: 'Poppins', sans-serif;
      color: #fff;
    }
    
    /* Navbar styling */
    .navbar-custom {
      background: rgba(0, 0, 0, 0.5);
    }
    
    .navbar-brand {
      font-weight: 600;
      font-size: 1.5rem;
    }
    
    /* Main header */
    .header-section {
      padding: 3rem 0;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
    }
    
    .header-section h3 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    /* Card styling */
    .card-custom {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 1rem;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }
    
    .card-custom:hover {
      transform: translateY(-5px);
    }
    
    /* Hide loader/download sections initially */
    #result, #download {
      display: none;
    }
    
    .font-large {
      font-size: 120px;
    }
    
    /* Custom button */
    .btn-custom {
      background-color: #28a745;
      border: none;
      transition: background-color 0.3s ease;
    }
    
    .btn-custom:hover {
      background-color: #218838;
    }
    
    /* PDF embed responsive */
    .embed-responsive {
      overflow: hidden;
      padding-bottom: 56.25%;
      position: relative;
      height: 0;
      border-radius: 1rem;
    }
    
    .embed-responsive embed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 1rem;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="#">Exam Generator</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" 
              data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" 
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>
  
  <!-- Header Section -->
  <section class="header-section">
    <div class="container">
      <h3>Generate Your Exam Questions Instantly</h3>
      <p>Upload a PDF (Max 5 pages) and get ready-to-use Q&A content.</p>
    </div>
  </section>
  
  <!-- Upload Section -->
  <section class="mb-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card card-custom p-4">
            <div class="mb-3">
              <label for="pdf-file" class="form-label fs-5">Upload your PDF file here</label>
              <div class="input-group">
                <input type="file" class="form-control" id="pdf-file" accept="application/pdf">
                <label class="input-group-text" for="pdf-file">Max 5 Pages</label>
              </div>
            </div>
            <div class="mb-3">
              <select class="form-select mb-3">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>
            <div class="text-end">
              <button type="button" id="upload-btn" class="btn btn-custom px-4 py-2">
                <i class="fas fa-upload me-2"></i>Generate Q&A
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Result Section -->
  <section id="result" class="mb-5">
    <div class="container">
      <div class="row">
        <!-- PDF Preview -->
        <div class="col-lg-6 mb-4">
          <div class="card card-custom p-3">
            <div class="embed-responsive">
              <embed id="view-pdf" src="" preload="auto">
            </div>
          </div>
        </div>
        <!-- Loader & Download -->
        <div class="col-lg-6 mb-4">
          <div class="card card-custom p-5 d-flex align-items-center justify-content-center" style="min-height: 600px;">
            <div id="loader" class="text-center">
              <i class="fa-solid fa-spinner fa-spin font-large"></i>
              <p class="mt-3 fs-4">Processing your file...</p>
            </div>
            <div id="download" class="text-center">
              <a href="" id="download-btn" class="btn btn-warning btn-lg" download>
                <i class="fas fa-download me-2"></i>Download Q&A
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Footer -->
  <footer class="py-3 text-center">
    <div class="container">
      <small>&copy; 2025 Exam Generator. All Rights Reserved.</small>
    </div>
  </footer>
  
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" 
    crossorigin="anonymous"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <!-- SweetAlert2 -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  
  <script>
    let result = document.getElementById('result');
    let loader = document.getElementById('loader');
    let download = document.getElementById('download');
    let viewPdf = document.getElementById('view-pdf');
    let downloadBtn = document.getElementById('download-btn');
  
    // Add a progress bar to show processing status
    const progressBar = `
    <div class="progress mb-3">
      <div class="progress-bar progress-bar-striped progress-bar-animated" 
           role="progressbar" style="width: 0%"></div>
    </div>`;

    $(document).ready(function () {
      $("#upload-btn").click(async function (event) {
        event.preventDefault();
        const formData = new FormData();
        const fileInput = document.getElementById('pdf-file');  
        var file = fileInput.files[0];           

        // Validate file before uploading
        if (!validateFile(file)) return;

        formData.append('pdf_file', file);
        formData.append('filename', file.name);
  
        let response = await fetch('/upload', {
          method: "POST",
          body: formData                
        });                
        processUploadResponse(response);  
      });
    });
  
    async function processUploadResponse(response){
      switch (response.status) {
        case 400:  
          Swal.fire({
            icon: 'error',
            title: 'Oops!',
            text: "Couldn't upload your PDF. Please try again.",
            confirmButtonColor: "#dc3545"
          }).then(() => window.location.reload());
          break;
        case 200:                 
          var json = await response.json();
          if (json.msg == "error") {
            Swal.fire({
              icon: 'error',
              title: 'Oops!',
              text: 'Maximum number of pages exceeded.',
              confirmButtonColor: "#dc3545"
            }).then(() => window.location.reload());
          } else {
            result.style.display = "block";
            loader.style.display = "block";
            download.style.display = "none";
            viewPdf.setAttribute('src', "../" + json.pdf_filename);
            viewPdf.setAttribute('preload', 'auto');
  
            const formData = new FormData();
            formData.append('pdf_filename', json.pdf_filename);
            fetch('/analyze', {
              method: "POST",
              body: formData                
            }).then(processAnalyzeResponse);
          }
          break;
        default:
          Swal.fire({
            icon: 'error',
            title: 'Oops!',
            text: "Error " + response.status + ". Please contact support.",
            confirmButtonColor: "#dc3545"
          }).then(() => window.location.reload());
      }
    }
  
    async function processAnalyzeResponse(response){
      switch (response.status) {
        case 400:  
          Swal.fire({
            icon: 'error',
            title: 'Oops!',
            text: "Couldn't analyze your PDF. Please try again.",
            confirmButtonColor: "#dc3545"
          }).then(() => window.location.reload());
          break;
        case 200:                     
          loader.style.display = "none";
          download.style.display = "block";
          var json = await response.json();
          downloadBtn.setAttribute('href', "../" + json.output_file);
          break;
        default:
          Swal.fire({
            icon: 'error',
            title: 'Oops!',
            text: "Error " + response.status + ". Please contact support.",
            confirmButtonColor: "#dc3545"
          }).then(() => window.location.reload());
      }
    }

    // Add file size and type validation
    function validateFile(file) {
      const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
      if (!file.type.includes('pdf')) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid File',
          text: 'Please upload a PDF file only'
        });
        return false;
      }
      if (file.size > MAX_FILE_SIZE) {
        Swal.fire({
          icon: 'error',
          title: 'File Too Large',
          text: 'Please upload a file smaller than 5MB'
        });
        return false;
      }
      return true;
    }
  </script>
</body>
</html>
